<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Finanças Pessoais</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Adicionando Chart.js -->
</head>

<body>

    <header>
        <h1>Controle de Finanças Pessoais</h1>
    </header>

    <nav>
        <a href="index.html">Tabela de Gastos</a>
        <a href="orcamento.html">Orçamento</a>
        <a href="cadastro.html">Cadastrar Despesa/Entrada</a>
        <a href="grafico.html">Gráfico de Saldo</a>
        <a href="categorias.html">Categorias e Subcategorias</a>
        <a href="linha_do_tempo.html">Linha do tempo</a>
        <a href="poupanca.html">Poupança</a>
        <a href="viagem.html">Viagem</a>
        <a href="serasa.html">Serasa</a>
    </nav>

    <main>

        <h2>Entradas e Saídas</h2>

        <div class="card-container">
            <div class="card card-entrada">
                <h3>Total Entradas</h3>
                <p id="total-entradas">0,00</p>
            </div>
            <div class="card card-saida">
                <h3>Total Saídas</h3>
                <p id="total-saidas">0,00</p>
            </div>
            <div class="card card-categorias">
                <h3>Total Geral</h3>
                <p id="total-categorias">0,00</p>
            </div>
        </div>

        <h2>Somatório por Categoria</h2>
        <div id="cards-categorias" class="card-container">
            <!-- Os cards de categoria serão inseridos aqui -->
        </div>

        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Categoria</th>
                    <th>Descrição</th>
                    <th>Valor (R$)</th>
                    <th>Tipo</th>
                    <th>Saldo (R$)</th> <!-- Nova coluna de saldo -->
                </tr>
            </thead>
            <tbody id="tabela-dados">
                <!-- Os dados serão inseridos aqui -->
            </tbody>
        </table>

        <button class="btn-cadastrar" onclick="window.location.href='cadastro.html'">Cadastrar Nova
            Despesa/Entrada</button>
    </main>

    <script>
        // Carregar as despesas de localStorage
        function carregarDespesas() {
            const despesas = JSON.parse(localStorage.getItem("despesas")) || [];
            return despesas;
        }

        function atualizarTabela() {
            const despesas = carregarDespesas();
            const tabela = document.getElementById("tabela-dados");
            tabela.innerHTML = ""; // Limpa a tabela

            let totalEntradas = 0;
            let totalSaidas = 0;
            const somatorioCategorias = {};
            let saldoAcumulado = 0; // Inicializa o saldo acumulado

            // Atualiza a tabela com os dados
            despesas.forEach(despesa => {
                const row = tabela.insertRow();

                const cellData = row.insertCell(0);
                const cellCategoria = row.insertCell(1);
                const cellDescricao = row.insertCell(2);
                const cellValor = row.insertCell(3);
                const cellTipo = row.insertCell(4);
                const cellSaldo = row.insertCell(5); // Nova célula para o saldo

                cellData.textContent = despesa.data;
                cellCategoria.textContent = despesa.categoria;
                cellDescricao.textContent = despesa.descricao;
                cellValor.textContent = despesa.valor.toFixed(2);
                cellTipo.textContent = despesa.tipo;

                // Atualiza o saldo acumulado
                if (despesa.tipo === "Entrada") {
                    totalEntradas += despesa.valor;
                    saldoAcumulado += despesa.valor; // Entradas somam no saldo
                } else {
                    totalSaidas += despesa.valor;
                    saldoAcumulado -= despesa.valor; // Saídas subtraem do saldo
                }

                // Calcula totais e somatório por categoria
                somatorioCategorias[despesa.categoria] = (somatorioCategorias[despesa.categoria] || 0) + despesa.valor;

                // Define o valor do saldo na célula
                cellSaldo.textContent = saldoAcumulado.toFixed(2); // Exibe o saldo
            });

            // Atualiza os totais
            document.getElementById("total-entradas").textContent = totalEntradas.toFixed(2);
            document.getElementById("total-saidas").textContent = Math.abs(totalSaidas).toFixed(2); // Exibe saída como positivo
            document.getElementById("total-categorias").textContent = (totalEntradas - totalSaidas).toFixed(2); // Saldo final

            // Atualiza os cards de somatório por categoria
            const cardsCategorias = document.getElementById("cards-categorias");
            cardsCategorias.innerHTML = ""; // Limpa os cards existentes

            for (const categoria in somatorioCategorias) {
                const card = document.createElement("div");
                card.className = "card card-categorias";
                card.innerHTML = `<h3>${categoria}</h3><p>${somatorioCategorias[categoria].toFixed(2)}</p>`;
                cardsCategorias.appendChild(card);
            }
        }

        // Função para criar o gráfico
        function criarGrafico() {
            const despesas = carregarDespesas();
            const ctx = document.getElementById("graficoDespesas").getContext("2d");

            // Coletando dados de categorias
            const categorias = {};
            despesas.forEach(despesa => {
                if (!categorias[despesa.categoria]) {
                    categorias[despesa.categoria] = 0;
                }
                categorias[despesa.categoria] += despesa.valor;
            });

            // Preparando os dados para o gráfico
            const labels = Object.keys(categorias);
            const valores = labels.map(categoria => categorias[categoria]);

            const grafico = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Despesas (R$)',
                        data: valores,
                        backgroundColor: valores.map(valor => valor >= 0 ? 'green' : 'red'),
                        borderColor: 'black',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valor (R$)'
                            }
                        }
                    }
                }
            });
        }

        // Inicializa a tabela ao carregar a página
        window.onload = function () {
            atualizarTabela();
            criarGrafico(); // Adiciona a chamada para criar o gráfico
        };
    </script>

</body>

</html>